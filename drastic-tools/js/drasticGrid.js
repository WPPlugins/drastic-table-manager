/* DrasticTools version 0.6.12
 * DrasticTools is released under the GPL license: 
 * Copyright (C) 2007 email: info@drasticdata.nl
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * =========================================================================================
 * If you find this sofware useful, we appreciate your donation on http://www.drasticdata.nl
 * Suggestions for improvement can be sent to: info@drasticdata.nl
 * ========================================================================================= 
 */
function html_entity_decode(B){var A,C=document.createElement("textarea");C.innerHTML=B;A=C.value;return A}var dsgrid={MSGUPDATEFAILED:"Failed to update cell",MSGREALLYDELETE:"Really delete this row?",MSGDELETEFAILED:"Failed to delete row",MSGINSERTFAILED:"Failed to add row",MSGREFRESHFAILED:"Failed to refresh grid",MSGCLICKSORT:"Sort on ",MSGDELETEROW:"Delete row",MSGCLICKEDIT:"Edit cell",MSGADDROW:"Add row"};var n=0;var DDTYPECHAR=n++;var DDTYPEINT=n++;var DDTYPEBOOL=n++;var DDTYPEURL=n++;var DDTYPEMAILTO=n++;var DDTYPEENUM=n++;var drasticGrid=new Class({options:{key:"",table_name:"",path:location.pathname,pathimg:"DrasticTools/img/",pagelength:20,colwidth:80,pp:0,sortcol:null,sort:null,columns:null,onClick:Class.empty,onMouseOver:Class.empty,onAddStart:Class.empty,onAddComplete:Class.empty,onDeleteStart:function(A){this.DefaultOnDeleteStart(A)},onDeleteComplete:Class.empty,onUpdateStart:Class.empty,onUpdateComplete:Class.empty},initialize:function(M,E){var N=this;N.container=$(M)||alert("container "+M+" not found...");N.setOptions(E);N.getMetaData();N.rowselected=-1;N.del1=N.options.pathimg+"del.gif";N.del2=N.options.pathimg+"del2.gif";N.delempty=N.options.pathimg+"delempty.gif";N.add1=N.options.pathimg+"add.gif";N.add2=N.options.pathimg+"add2.gif";N.sort1=N.options.pathimg+"sort1.gif";N.sort2=N.options.pathimg+"sort2.gif";N.sortno=N.options.pathimg+"sortno.gif";N.edit=N.options.pathimg+"edit15x15transparant.png";N.editmo=N.options.pathimg+"edit15x15.png";N.imgsrcup=N.options.pathimg+"up.png";N.imgsrcdown=N.options.pathimg+"down.png";N.ddPowered=N.options.pathimg+"DDPowered.png";N.ddPowered2=N.options.pathimg+"DDPowered2.png";N.gifloading=N.options.pathimg+"loading.gif";N.columns=[];if(N.options.columns){for(var S=0,R=0;S<N.options.columns.length;S++,R++){if(!N.cols.contains(N.options.columns[S].name)){alert("no field with name '"+N.options.columns[S].name+"' in data source");continue}N.columns[R]={};N.columns[R].name=N.options.columns[S].name;if($defined(N.options.columns[S].type)){N.columns[R].type=N.options.columns[S].type}if($defined(N.options.columns[S].values)){N.columns[R].type=N.options.columns[S].values}if($defined(N.options.columns[S].displayname)){N.columns[R].displayname=N.options.columns[S].displayname}if($defined(N.options.columns[S].editable)){N.columns[R].editable=N.options.columns[S].editable}if($defined(N.options.columns[S].width)){N.columns[R].width=N.options.columns[S].width}}}else{for(var S=0;S<N.cols.length;S++){N.columns[S]={};N.columns[S].name=N.cols[S]}}for(var S=0;S<N.columns.length;S++){if(!$defined(N.columns[S].type)){var O=N.flds.get(N.columns[S].name);if(O.search("^tinyint")==0){N.columns[S].type=DDTYPEBOOL}else{if(N.cols_numeric.contains(N.columns[S].name)){N.columns[S].type=DDTYPEINT}else{if(O.search("^enum")==0){N.columns[S].type=DDTYPEENUM;N.columns[S].values=[];var A=O.split("'");for(var R=1,Q=0;R<A.length;R+=2,Q++){N.columns[S].values[Q]=A[R]}}else{N.columns[S].type=DDTYPECHAR}}}}if(!$defined(N.columns[S].editable)){N.columns[S].editable=N.editablecols.contains(N.columns[S].name)}if(!$defined(N.columns[S].displayname)){N.columns[S].displayname=N.columns[S].name}if(!$defined(N.columns[S].width)){N.columns[S].width=N.options.colwidth}}var U=new Element("table",{"class":"drasticgrid"}).inject(N.container);var B=new Element("tbody").inject(U);var J=new Element("tr").inject(B);var F=15;var G=16;var I=new Element("th",{styles:{width:G}}).inject(J);var H=new Element("th",{id:N.container.id+"__del",styles:{width:F}}).inject(J);F+=G;for(var S=0;S<N.columns.length;S++){var L=N.columns[S].name;F+=N.columns[S].width;var H=new Element("th",{id:N.container.id+L,"class":"th",styles:{width:N.columns[S].width}}).inject(J);H.addEvent("mouseover",function(){this.addClass("thmouseover")});H.addEvent("mouseout",function(){this.removeClass("thmouseover")});var P=new Element("div",{"class":"divth",styles:{width:N.columns[S].width}}).inject(H);P.set("text",N.columns[S].displayname);var T=(N.options.sortcol!=L)?N.sortno:(N.options.sort=="d"?N.sort2:N.sort1);var W=new Element("img",{alt:"","class":"imgsort",src:T}).inject(P);if(N.options.sortcol==L){N.sortgif=W}P.addEvent("click",function(){N.td_sort(this)});P.setProperty("title",dsgrid.MSGCLICKSORT+P.get("text"))}N.container.setStyle("width",F);for(var S=0;S<N.options.pagelength;S++){var V=((S%2)==0)?"tdeven":"tdodd";var J=new Element("tr",{id:N.container.id+"row"+S,"class":V}).inject(B);J.addEvent("mouseover",function(){this.addClass("rowmouseover");if(N.data&&N.data[0]){var X=this.id.slice(N.container.id.length+3).toInt();N.fireEvent("onMouseOver",N.data[0][X])}});J.addEvent("mouseout",function(){this.removeClass("rowmouseover")});if(S==0){N.tdslider=new Element("td",{id:"colslider",rowspan:N.options.pagelength}).inject(J)}var K=new Element("td",{"class":"divdel"}).inject(J);var W=new Element("img",{id:"del"+S,alt:"","class":"imgdel",src:N.delempty}).inject(K);for(var R=0;R<N.columns.length;R++){var K=new Element("td",{id:"td"+S,styles:{width:N.columns[R].width}}).inject(J);K.ddcolumn=N.columns[R];K.ddrow=S;var D=new Element("div",{"class":"tddiv",styles:{width:N.columns[R].width}}).inject(K);var C=new Element("div",{id:"divtd"+S+":"+K.ddcolumn.name,"class":"divtd"}).inject(D);K.addEvent("click",function(){$(N.container).getElements("tr.rowselected").removeClass("rowselected");this.getParent().addClass("rowselected");if(!this.ddempty){N.rowselected=N.data[0][this.ddid];N.fireEvent("onClick",N.data[0][this.ddid])}})}}var J=new Element("tr").inject(B);var K=new Element("td",{colspan:N.columns.length+1,styles:{"text-align":"left"}}).inject(J);var W=new Element("img",{title:"Powered by DrasticData",src:N.ddPowered}).inject(K);W.addEvent("click",function(){window.open("http://www.drasticdata.nl")});W.addEvent("mouseover",function(){this.src=N.ddPowered2});W.addEvent("mouseout",function(){this.src=N.ddPowered});W.setStyle("cursor","pointer");N.loading=new Element("div",{styles:{position:"absolute","z-index":"100"}}).inject(N.container);var W=new Element("img",{src:N.gifloading}).inject(N.loading);N.refresh()},getMetaData:function(){var A=this;var B=new Request({url:A.options.path,async:false,method:"get",onFailure:function(){alert(dsgrid.MSGREFRESHFAILED)},onSuccess:function(C){A.metadata=JSON.decode(C);A.num_rows=A.metadata[0];A.num_fields=A.metadata[1];A.idname=A.metadata[2];A.idcolnr=A.metadata[3];A.cols=A.metadata[4];A.cols_numeric=A.metadata[5];A.add_allowed=A.metadata[6];A.delete_allowed=A.metadata[7];A.editablecols=A.metadata[8];A.defaultcols=A.metadata[9];if(!A.options.sortcol){A.options.sortcol=A.metadata[10]}if(!A.options.sort){A.options.sort=A.metadata[11]}A.flds=new Hash(A.metadata[12]);A.ppmax=Math.ceil(A.num_rows/A.options.pagelength)-1}}).send("tab="+A.options.table_name+"&key="+A.options.key+"&op=vm")},showLoading:function(){var A=this;var B=A.container.getCoordinates();A.loading.setStyles({visibility:"visible",top:B.top+(B.height/2)-16,left:B.left+(B.width/2)-16})},hideLoading:function(){var A=this;A.loading.setStyles({visibility:"hidden"})},UpdateCell:function(E,C){var B=this;if(C==html_entity_decode(E.ddoldvalue)){B.restore_form(E,null);return }var G=E.ddid;var D=E.ddcolumn.name;var A=B.options.path+"?tab="+B.options.table_name+"&key="+B.options.key+"&op=u&id="+E.ddsqlid+"&col="+D+"&value="+encodeURIComponent(C);B.fireEvent("onUpdateStart",G,D,C);B.showLoading();var F=new Request({url:A,method:"get",onFailure:function(){B.hideLoading();alert(dsgrid.MSGUPDATEFAILED);B.restore_form(E,null)},onComplete:function(H){B.hideLoading();if(H[0]=="0"){alert(dsgrid.MSGUPDATEFAILED);B.restore_form(E,null)}else{B.fireEvent("onUpdateComplete",G,D,C);B.restore_form(E,C);new Fx.Tween(E,{duration:4000}).start("color","#F00","#505050")}}}).send()},restore_form:function(B,A){if(B.ddcolumn.type==DDTYPEBOOL){return }B.firstChild.dispose();B.ddoldchild.inject(B);if(!A){return }switch(B.ddcolumn.type){case DDTYPECHAR:B.firstChild.firstChild.set("text",A);break;case DDTYPEINT:B.firstChild.firstChild.set("text",A);break;case DDTYPEBOOL:break;case DDTYPEURL:B.firstChild.firstChild.firstChild.set("text",A);break;case DDTYPEMAILTO:B.firstChild.firstChild.firstChild.set("text",A);break;case DDTYPEENUM:B.firstChild.firstChild.set("text",A);break}},create_form:function(E){var C=this;switch(E.ddcolumn.type){case DDTYPECHAR:E.ddvalue=E.firstChild.firstChild.innerHTML;break;case DDTYPEINT:E.ddvalue=E.firstChild.firstChild.innerHTML;break;case DDTYPEBOOL:break;case DDTYPEURL:E.ddvalue=E.firstChild.firstChild.firstChild.innerHTML;break;case DDTYPEMAILTO:E.ddvalue=E.firstChild.firstChild.firstChild.innerHTML;break;case DDTYPEENUM:E.ddvalue=E.firstChild.firstChild.innerHTML;break}E.ddoldchild=E.firstChild;E.firstChild.dispose();E.ddoldvalue=E.ddvalue;var D;if(E.ddcolumn.type==DDTYPEENUM){D=new Element("select").inject(E);for(var B=0;B<E.ddcolumn.values.length;B++){var A=new Element("option",{selected:((E.ddvalue==E.ddcolumn.values[B])?true:false),value:E.ddcolumn.values[B]}).inject(D);A.appendText(E.ddcolumn.values[B])}D.setStyle("width",E.ddcolumn.width);D.addEvent("keydown",function(G){var F=new Event(G);if(F.key=="enter"){C.UpdateCell(F.target.getParent(),F.target.value)}if(F.key=="esc"){C.restore_form(F.target.getParent(),null)}});D.addEvent("change",function(){C.UpdateCell(this.getParent(),this.value)});D.addEvent("blur",function(){C.UpdateCell(this.getParent(),this.value)});D.focus()}else{D=new Element("input",{type:"text",value:html_entity_decode(E.ddvalue)}).inject(E);D.setStyle("width",E.ddcolumn.width);D.addEvent("keydown",function(G){var F=new Event(G);if(F.key=="enter"){C.UpdateCell(F.target.getParent(),F.target.value)}if(F.key=="esc"){C.restore_form(F.target.getParent(),null)}});D.addEvent("blur",function(){C.UpdateCell(this.getParent(),this.value)});D.focus();D.select()}},tr_del:function(D){var B=this;var G=D.id.slice(3);var E=B.container.getElementById(B.container.id+"row"+G);if(E.ddempty){return }var C=B.data[0][G];new Fx.Tween(E,{duration:500}).start("color","#000","#A0A0A0");B.do_delete=true;B.fireEvent("onDeleteStart",C);if(B.do_delete){var A=B.options.path+"?tab="+B.options.table_name+"&key="+B.options.key+"&op=d&id="+C;B.showLoading();var F=new Request({url:A,method:"get",onFailure:function(){B.hideLoading();alert(dsgrid.MSGDELETEFAILED);new Fx.Tween(E,{duration:300}).start("color","#A0A0A0","#000")},onComplete:function(){if(B.data[0].length==1){B.options.pp=Math.max(0,B.options.pp-1)}B.getMetaData();B.refresh();new Fx.Tween(E,{duration:300}).start("color","#A0A0A0","#000");B.hideLoading();B.fireEvent("onDeleteComplete",C)}}).send()}else{new Fx.Tween(E,{duration:300}).start("color","#A0A0A0","#000")}},tr_add:function(C){var B=this;B.fireEvent("onAddStart");var A=B.options.path+"?tab="+B.options.table_name+"&key="+B.options.key+"&op=a";B.showLoading();var D=new Request({url:A,method:"get",onFailure:function(){alert(dsgrid.MSGINSERTFAILED);B.hideLoading()},onComplete:function(){B.getMetaData();if(B.options.pp==B.ppmax&&B.data[0]&&(B.data[0].length==B.options.pagelength)){B.options.pp=B.ppmax+1}else{B.options.pp=B.ppmax}B.refresh();B.hideLoading();B.fireEvent("onAddComplete")}}).send()},td_sort:function(B){var A=this;var C=B.getParent().id.slice(A.container.id.length);if(A.options.sortcol==C&&A.options.sort=="a"){A.options.sort="d";B.getLast().src=A.sort2}else{if(A.sortgif){A.sortgif.src=A.sortno}A.options.sortcol=C;A.options.sort="a";A.sortgif=B.getLast();A.sortgif.src=A.sort1}A.refresh()},destroySlider:function(){var A=this;A.divslider.destroy();A.divup.destroy();A.divdown.destroy();A.divslider=A.knob=A.slider=null;A.tdslider.removeClass("visible")},pagepointers:function(){var B=this;var A=(B.num_rows<B.options.pagelength)?false:true;B.ppmax=Math.ceil((B.add_allowed?B.num_rows+1:B.num_rows)/B.options.pagelength)-1;if(!A&&B.slider){B.destroySlider()}if(A&&B.slider){if(B.ppmax!=B.ppmaxold){B.destroySlider();B.ppmaxold=B.ppmax}}if(A&&!B.slider){B.tdslider.addClass("visible");B.divup=new Element("div",{"class":"up"}).inject(B.tdslider);B.imgup=new Element("img",{alt:"previous","class":"imgup",src:B.imgsrcup}).inject(B.divup);B.heightdivslider=B.tdslider.getSize().y-(2*(B.divup.getSize().y));B.hknob=Math.max(B.heightdivslider/(B.ppmax+1),20);B.divslider=new Element("div",{"class":"slider",styles:{height:B.heightdivslider,width:B.divup.getSize().x}}).inject(B.tdslider);B.knob=new Element("div",{"class":"knob",styles:{height:B.hknob}}).inject(B.divslider);B.tick=new Element("div",{id:"tick",text:11}).inject(B.knob);B.tick.setStyle("top",(B.hknob/2)-(B.tick.getSize().y/2));B.slider=new Slider(B.divslider,B.knob,{range:[1,B.ppmax+1],wheel:true,snap:true,mode:"vertical",onComplete:function(C){if((B.options.pp+1)!=C){B.options.pp=C-1;B.refresh()}},onChange:function(C){$("tick").set("text",C);B.tick.setStyle("left",(B.knob.getSize().x/2)-(B.tick.getSize().x/2)-1)}});B.ppmaxold=B.ppmax;B.divdown=new Element("div",{"class":"down"}).inject(B.tdslider);B.imgdown=new Element("img",{alt:"next","class":"imgdown",src:B.imgsrcdown}).inject(B.divdown);B.knob.addEvent("mouseenter",function(){this.addClass("knobmouseover")});B.knob.addEvent("mouseleave",function(){this.removeClass("knobmouseover")});B.divup.addEvent("mouseenter",function(){this.addClass("upmouseover")});B.divup.addEvent("mouseleave",function(){this.removeClass("upmouseover")});B.divup.addEvent("click",function(){if((B.options.pp)>0){B.options.pp--;B.refresh()}});B.divdown.addEvent("mouseenter",function(){this.addClass("downmouseover")});B.divdown.addEvent("mouseleave",function(){this.removeClass("downmouseover")});B.divdown.addEvent("click",function(){if((B.options.pp)<B.ppmax){B.options.pp++;B.refresh()}})}if(B.slider){B.slider.set(B.options.pp+1);B.tick.setStyle("left",(B.knob.getSize().x/2)-(B.tick.getSize().x/2)-1)}},refresh:function(){var C=this;var E=C.options.pp*C.options.pagelength;var A=E+C.options.pagelength;var B=C.options.path+"?tab="+C.options.table_name+"&key="+C.options.key+"&op=v&start="+E+"&end="+A+"&cols="+C.cols+"&sortcol="+C.options.sortcol+"&sort="+C.options.sort;C.showLoading();var D=new Request({url:B,method:"get",onFailure:function(){alert(dsgrid.MSGREFRESHFAILED)},onComplete:function(L){C.data=JSON.decode(L);C.pagepointers();var N=C.data[1];var F=false;for(var J=0;J<C.options.pagelength;J++){var O=C.container.getElementById(C.container.id+"row"+J);O.ddempty=(N&&(J<N.length))?false:true;if(!O.ddempty&&C.data[0]&&(C.rowselected==C.data[0][J])){O.addClass("rowselected")}else{O.removeClass("rowselected")}var K=O.getFirst();if(J==0){K=K.getNext()}K=K.getFirst();K.removeEvents();K.src=C.delempty;K.setStyle("cursor",null);if(!O.ddempty&&C.delete_allowed){K.src=C.del1;K.addEvent("click",function(){C.tr_del(this)});K.setProperty("title",dsgrid.MSGDELETEROW);K.addEvent("mouseover",function(){this.src=C.del2});K.addEvent("mouseout",function(){this.src=C.del1});K.setStyle("cursor","pointer")}if(O.ddempty&&C.add_allowed&&!F){K.src=C.add1;K.addEvent("click",function(){C.tr_add(this)});K.setProperty("title",dsgrid.MSGADDROW);K.addEvent("mouseover",function(){this.src=C.add2});K.addEvent("mouseout",function(){this.src=C.add1});K.setStyle("cursor","pointer");F=true}for(var I=0;I<C.columns.length;I++){var G=C.container.getElementById("divtd"+J+":"+C.columns[I].name);G.empty();if(G.getNext()){G.getNext().dispose()}if(O.ddempty){continue}var H=G.getParent().getParent();H.ddid=J;H.ddsqlid=C.data[0][J];H.ddempty=(N&&(J<N.length)&&N[J][I])?false:true;if(H.ddcolumn.type==DDTYPEBOOL){var M=new Element("input",{type:"checkbox",disabled:!H.ddcolumn.editable,styles:{height:"13px"}}).inject(G);if(!H.ddempty&&N[J][I]!=0){M.checked=true}if(H.ddcolumn.editable){M.addEvent("change",function(){var Q=this.getParent().getParent().getParent();var P=this.checked?1:0;Q.ddoldvalue=P?0:1;C.UpdateCell(Q,P)})}}else{if(H.ddcolumn.type==DDTYPEURL){G.set("html",(H.ddempty)?"&nbsp;":'<a href="'+N[J][I]+'">'+N[J][I]+"</a>")}else{if(H.ddcolumn.type==DDTYPEMAILTO){G.set("html",(H.ddempty)?"&nbsp;":'<a href="mailto:'+N[J][I]+'">'+N[J][I]+"</a>")}else{G.set("html",(H.ddempty)?"&nbsp;":(N[J][I]))}}if(H.ddcolumn.editable){var K=new Element("img",{src:C.edit,"class":"imgedit"}).inject(H.getLast());K.addEvent("mouseover",function(){var P=this.getParent().getParent().getParent();if(!P.ddempty){this.src=C.editmo}});K.addEvent("mouseout",function(){this.src=C.edit});K.addEvent("click",function(){var Q=this.getParent().getParent();var P=Q.getParent();if(!P.ddempty){this.src=C.edit;C.create_form(Q)}});K.setProperty("title",dsgrid.MSGCLICKEDIT)}}}}C.hideLoading()}}).send()},SelectPagePointer:function(A){var B=this;B.options.pp=A;B.refresh()},DefaultOnClick:function(C){var A=this;var B=new Request({url:A.options.path,async:false,method:"get",onFailure:function(){return(-1)},onSuccess:function(D){A.rownr=JSON.decode(D);if(A.rownr==-1){return(-1)}A.rowselected=C;A.options.pp=Math.floor(A.rownr/A.options.pagelength);A.refresh();return(0)}}).send("tab="+A.options.table_name+"&key="+A.options.key+"&op=vrn&id="+C)},DefaultOnDeleteStart:function(B){var A=this;if(!window.confirm(dsgrid.MSGREALLYDELETE)){A.do_delete=false}}});drasticGrid.implement(new Options,new Events);